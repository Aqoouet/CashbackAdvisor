# План разработки (Development Roadmap)

Документ описывает дальнейшие изменения проекта в рекомендуемом порядке внедрения.

---

## Этап 1: Улучшение базовой логики и форматов данных

### 1.1. Изменение формата даты
**Приоритет:** Высокий  
**Описание:** Заменить формат месяца на формат даты окончания действия кэшбэка.

**Изменения:**
- Вместо месяца (`YYYY-MM`) использовать дату окончания в формате `дд.мм.гггг`
- Если дата не указана, устанавливать последний день текущего месяца
- Обновить парсер для поддержки нового формата
- Обновить валидацию в `validator.go`
- Обновить модели данных (если необходимо)
- Обновить описание в командах `/start` и `/help`

**Файлы для изменения:**
- `internal/bot/parser.go` - парсинг даты
- `internal/validator/validator.go` - валидация даты
- `internal/models/cashback.go` - модель данных (если нужно)
- `internal/bot/commands.go` - обновить тексты `/start` и `/help`
- `internal/database/repository.go` - SQL запросы (если нужно)

---

### 1.2. Логика категории "Все покупки"
**Приоритет:** Высокий  
**Описание:** Добавить специальную категорию "Все покупки" как fallback.

**Логика:**
- Если в команде `/best` категория не найдена ИЛИ найденный кэшбэк меньше, чем "Все покупки" → выводить кэшбэк на "Все покупки"
- Добавить ясное сообщение о том, что показывается кэшбэк на "Все покупки"
- Учесть эту категорию при поиске лучшего кэшбэка

**Файлы для изменения:**
- `internal/bot/cashback.go` - метод `handleBestQueryWithCorrection()`
- `internal/service/service.go` - метод `GetBestCashback()`
- `internal/database/repository.go` - запрос `GetBestCashback` (если нужно)

---

### 1.3. Улучшение поиска похожих категорий
**Приоритет:** Средний  
**Описание:** Улучшить алгоритм поиска похожих категорий.

**Требования:**
- Учитывать лучшую похожесть среди всех слов (исключая предлоги)
- Гарантировать, что при вводе "Фастфуд" категория "Фастфуд и Рестораны" будет показана

**Файлы для изменения:**
- `internal/bot/similarity.go` - функция `findSimilarCategory()` и `scoreCategory()`
- `internal/bot/cashback.go` - использование поиска

---

## Этап 2: Улучшение UI/UX

### 2.1. Упрощение текста "кешбэк %"
**Приоритет:** Низкий  
**Описание:** Заменить "кешбэк %" на просто "кешбэк" во всех сообщениях.

**Файлы для изменения:**
- `internal/bot/messages.go` - все функции форматирования
- `internal/bot/commands.go` - тексты команд
- `internal/bot/cashback.go` - сообщения

---

### 2.2. Кнопка /start всегда активна
**Приоритет:** Средний  
**Описание:** Кнопка `/start` должна всегда присутствовать в клавиатуре.

**Файлы для изменения:**
- `internal/bot/keyboard.go` - функция `defaultCommandButtons()` или `buildKeyboard()`

---

### 2.3. Улучшенные описания в /help и /start
**Приоритет:** Высокий  
**Описание:** Добавить подробное объяснение назначения бота.

**Требования:**
- Объяснить, что бот НЕ выводит информацию из интернета
- Бот показывает только информацию, добавленную пользователями
- Кэшбэк показывается для пользователя и членов его группы
- Если не войти в группу, кэшбэк показан не будет
- Группа нужна для разделения кэшбэка разных групп

**Файлы для изменения:**
- `internal/bot/commands.go` - функции `handleStart()` и `handleHelp()`

---

### 2.4. Кнопка "Изменить вручную" при предложениях исправлений
**Приоритет:** Средний  
**Описание:** Добавить кнопку для ручного ввода при предложении исправлений.

**Требования:**
- При любом предложении исправления ошибки ввода должна быть кнопка "Изменить вручную"
- После нажатия пользователь может ввести правильный вариант

**Файлы для изменения:**
- `internal/bot/keyboard.go` - добавить кнопку
- `internal/bot/states.go` - обработка нового состояния
- `internal/bot/cashback.go` - добавление кнопки в предложения

---

### 2.5. Навигационные кнопки <- и -> для листания команд
**Приоритет:** Средний  
**Описание:** Улучшить UI клавиатуры с навигацией.

**Требования:**
- Бот показывает 4 кнопки в две колонки
- Под ними кнопки `<-` и `->` для листания команд
- Реализовать пагинацию команд

**Файлы для изменения:**
- `internal/bot/keyboard.go` - новая логика построения клавиатуры
- `internal/bot/bot.go` - обработка callback для навигации

---

## Этап 3: Улучшение существующих команд

### 3.1. Команда /help [command_name]
**Приоритет:** Высокий  
**Описание:** Добавить детальную справку по конкретной команде.

**Требования:**
- `/help` - полное описание всех команд
- `/help command_name` - подробное описание выбранной команды
- Добавить описания для всех новых команд

**Файлы для изменения:**
- `internal/bot/commands.go` - функция `handleHelp()`
- Создать структуру для хранения описаний команд

---

### 3.2. Команда /best - показывать все похожие предложения
**Приоритет:** Средний  
**Описание:** Выводить все предложения, прошедшие проверку похожести.

**Требования:**
- Вместо одного лучшего результата показывать все похожие категории
- Отсортировать по убаванию значения кешбека

**Файлы для изменения:**
- `internal/bot/cashback.go` - метод `handleBestQueryWithCorrection()`
- `internal/bot/messages.go` - форматирование списка результатов

---

### 3.3. Команда /list - табличный вид и пагинация
**Приоритет:** Высокий  
**Описание:** Улучшить вывод списка кэшбэков.

**Требования:**
- Выводить информацию в табличном виде
- По умолчанию показывать последние 5 строк
- `/list all` - показать все строки
- `/list a-b,c` - показать строки с номерами a по b, а также строку c

**Файлы для изменения:**
- `internal/bot/commands.go` - функция `handleList()`
- `internal/bot/messages.go` - функция `formatCashbackList()` для табличного вида
- `internal/bot/parser.go` - парсинг параметров `/list`

---

### 3.4. Команда /update - показывать текущую строку для копирования
**Приоритет:** Средний  
**Описание:** Улучшить UX команды обновления.

**Требования:**
- Отдельным сообщением вывести строку, которая обновляется
- Прочитать текущее значение из базы
- Вывести строку через запятую в формате, как она была введена
- Пользователь может скопировать, изменить и отправить

**Файлы для изменения:**
- `internal/bot/commands.go` - функция `handleUpdateCommand()`
- `internal/bot/messages.go` - форматирование строки для копирования
- `internal/bot/parser.go` - обратное преобразование в формат ввода

---

### 3.5. Команда /add - мультистрочный ввод
**Приоритет:** Средний  
**Описание:** Разрешить добавление нескольких кэшбэков за один ввод.

**Требования:**
- Поддержать ввод нескольких строк
- Каждая строка - отдельный кэшбэк в формате через запятую
- Обработать все строки и показать результаты

**Файлы для изменения:**
- `internal/bot/commands.go` - функция `handleAddCommand()`
- `internal/bot/cashback.go` - обработка мультистрочного ввода
- `internal/bot/parser.go` - парсинг нескольких строк

---

## Этап 4: Новые команды

### 4.1. Команда /bankinfo bank_name
**Приоритет:** Высокий  
**Описание:** Показать активный кэшбэк по банку в группе.

**Требования:**
- Валидация ввода имени банка
- Поиск похожих банков (fuzzy search)
- Вывод всех активных кэшбэков по указанному банку в группе
- Учесть текущую дату (активные = не истёкшие)
- Табличный формат выода

**Файлы для создания/изменения:**
- `internal/bot/commands.go` - функция `handleBankInfo()`
- `internal/database/repository.go` - метод `GetCashbackByBank()`
- `internal/service/service.go` - метод `GetCashbackByBank()`
- `internal/handlers/handlers.go` - обработчик HTTP (если нужен API)

---

### 4.2. Команда /categorylist
**Приоритет:** Средний  
**Описание:** Вывести список всех активных категорий с уникальными именами по группе.

**Требования:**
- Показать все уникальные категории, по которым есть активный кэшбэк
- Только для текущей группы
- Учесть текущую дату (активные = не истёкшие)

**Файлы для создания/изменения:**
- `internal/bot/commands.go` - функция `handleCategoryList()`
- `internal/database/repository.go` - метод `GetActiveCategories()`
- `internal/service/service.go` - метод `GetActiveCategories()`

---

### 4.3. Команда /banklist
**Приоритет:** Средний  
**Описание:** Вывести список всех банков, по которым есть активный кэшбэк в группе.

**Требования:**
- Показать все уникальные банки с активным кэшбэком
- Только для текущей группы
- Учесть текущую дату

**Файлы для создания/изменения:**
- `internal/bot/commands.go` - функция `handleBankList()`
- `internal/database/repository.go` - метод `GetActiveBanks()`
- `internal/service/service.go` - метод `GetActiveBanks()`

---

### 4.4. Команда /userinfo [ID]
**Приоритет:** Средний  
**Описание:** Показать кэшбэки пользователя.

**Требования:**
- Если ID не указан - показать кэшбэки текущего пользователя
- Если ID указан - показать кэшбэки указанного пользователя
- Вывод в табличном виде (как в `/list`)

**Файлы для создания/изменения:**
- `internal/bot/commands.go` - функция `handleUserInfo()`
- `internal/database/repository.go` - метод `GetCashbackByUser()` (если нужно)
- Использовать существующий `List()` с фильтром по user_id

---

### 4.5. Команда /userlist [a-b,c|all]
**Приоритет:** Низкий  
**Описание:** Вывести список пользователей в табличном виде.

**Требования:**
- Вывод: пользователь, ID, группа
- Поддержка пагинации: `/userlist a-b,c` или `/userlist all`
- Табличный формат

**Файлы для создания/изменения:**
- `internal/bot/commands.go` - функция `handleUserList()`
- `internal/database/repository.go` - метод `GetUsersList()` (если нужно)
- `internal/service/service.go` - метод `GetUsersList()`
- `internal/bot/messages.go` - форматирование таблицы пользователей

---

## Порядок внедрения (рекомендуемый)

### Фаза 1: Фундаментальные изменения (1-2 недели)
1. ✅ 1.1. Изменение формата даты
2. ✅ 1.2. Логика категории "Все покупки"


### Фаза 2: Улучшение существующих команд (1-2 недели)
5. ✅ 3.3. Команда /list - табличный вид и пагинация
6. ✅ 3.2. Команда /best - показывать все похожие предложения
7. ✅ 3.4. Команда /update - показывать текущую строку
8. ✅ 3.5. Команда /add - мультистрочный ввод

### Фаза 3: Новые команды (1-2 недели)
9. ✅ 4.1. Команда /bankinfo bank_name
10. ✅ 4.2. Команда /categorylist
11. ✅ 4.3. Команда /banklist
12. ✅ 4.4. Команда /userinfo [ID]

### Фаза 4: UI/UX улучшения (1 неделя)
13. ✅ 2.1. Упрощение текста "кешбэк %"
14. ✅ 2.2. Кнопка /start всегда активна
15. ✅ 2.4. Кнопка "Изменить вручную"
16. ✅ 2.5. Навигационные кнопки <- и ->

### Фаза 5: Дополнительные улучшения (1 неделя)
17. ✅ 1.3. Улучшение поиска похожих категорий
18. ✅ 4.5. Команда /userlist


### Фаза 6: Обновить все описания
3. ✅ 2.3. Улучшенные описания в /help и /start
4. ✅ 3.1. Команда /help [command_name]

---

## Технические заметки

### Изменения в базе данных
- Возможно, потребуется миграция для изменения типа поля `month_year` на `expiry_date` (DATE)
- Или добавить новое поле `expiry_date` и постепенно мигрировать данные

### Обратная совместимость
- При изменении формата даты нужно учесть существующие данные
- Возможно, потребуется конвертация старых записей

### Тестирование
- После каждого этапа проводить тестирование
- Особое внимание к парсингу дат и валидации
- Проверить работу с группами

---

## Приоритеты

**Критичные (сделать в первую очередь):**
- 1.1, 1.2, 2.3, 3.1, 3.3, 4.1

**Важные (сделать во вторую очередь):**
- 3.2, 3.4, 3.5, 4.2, 4.3, 4.4

**Желательные (можно отложить):**
- 2.1, 2.2, 2.4, 2.5, 1.3, 4.5

---

**Дата создания документа:** 2024  
**Версия:** 1.0  
**Статус:** Активный план разработки

